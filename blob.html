<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Audio Visualizer</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	</head>
	<body>
        <style>
            html, body, div, span, applet, object, iframe,
            h1, h2, h3, h4, h5, h6, p, blockquote, pre,
            a, abbr, acronym, address, big, cite, code,
            del, dfn, em, img, ins, kbd, q, s, samp,
            small, strike, strong, sub, sup, tt, var,
            b, u, i, center,
            dl, dt, dd, ol, ul, li,
            fieldset, form, label, legend,
            table, caption, tbody, tfoot, thead, tr, th, td,
            article, aside, canvas, details, embed,
            figure, figcaption, footer, header, hgroup,
            menu, nav, output, ruby, section, summary,
            time, mark, audio, video {
            margin: 0;
            padding: 0;
            border: 0;
            font-size: 100%;
            font: inherit;
            vertical-align: baseline;
            }
            /* HTML5 display-role reset for older browsers */
            article, aside, details, figcaption, figure,
            footer, header, hgroup, menu, nav, section {
            display: block;
            }
            body {
            line-height: 1;
            }
            ol, ul {
            list-style: none;
            }
            blockquote, q {
            quotes: none;
            }
            blockquote:before, blockquote:after,
            q:before, q:after {
            content: '';
            content: none;
            }
            table {
            border-collapse: collapse;
            border-spacing: 0;
            }

            html, body {
                height:100%;
                width:100%;
            }

            html {
                box-sizing: border-box;
            }

            *, *:before, *:after {
                box-sizing: inherit;
            }

			.menu {
		        position:absolute;
		        right: 0px;
		        top: 0px;
		        padding: 1rem;
		        background: rgba(255,255,255,0.5);
		    }

		    button {
		        width: 50%;
		    }

            ::-webkit-scrollbar {
                width: 0px;  /* remove scrollbar space */
                background: transparent;  /* optional: just make scrollbar invisible */
            }

            ::-webkit-scrollbar-thumb {
                background: #FF0000;
            }
        </style>
		<script src="common/lib/three.min.js"></script>
        <script src="common/lib/OrbitControls.js"></script>
        <script src="common/lib/CopyShader.js"></script>
        <script src="common/lib/ConvolutionShader.js"></script>
        <script src="common/lib/EffectComposer.js"></script>
		<script src="common/lib/RenderPass.js"></script>
		<script src="common/lib/ShaderPass.js"></script>
        <script src="common/lib/BloomPass.js"></script>
        <script src="common/lib/ShaderExtras.js"></script>
		<script>
		// YOU NEED TO CHANGE THE ARRAY OF SONG URLs AND
		// TITLES. Alternate MP3 file URLs and titles, in quotes
		// and separated by commas, beginning with the first song URL.
		// If you use " marks in filenames or titles, or put a \
		// in front of them.
		var songs = new Array(
		  "",
		  "-- Select a song --",
		  "songs/speaking_gently.mp3",
		  "Speaking Gently",
		  "songs/such_great_heights.mp3",
		  "Such Great Heights",
		  "songs/someday_my_prince.mp3",
		  "Someday My Prince Will Come - Miles Davis",
		  "songs/frontier_village_night.mp3",
		  "Xenoblade Chronicles: Frontier Village (Night)",
		  "songs/fuck_cancer.mp3",
		  "Fuck Cancer",
		  "songs/jazz.mp3",
		  "Jazz",
		  "songs/really_love.mp3",
		  "Really Love",
		  "songs/rough_soul_remix.mp3",
		  "Rough Soul",
		  "songs/my_girl.mp3",
		  "My Girl",
          "songs/opus.mp3",
          "OPUS",
          "songs/something_they_dont_know.mp3",
          "Something They Don't Know"
		);

		function switchSongs(i)
		{
		  var file = songs[i * 2];
		  var selector = document.getElementById('song_selector');
		  selector.selectedIndex = i;
		  if (i != 0) {
		    load_music(file);
		  }
		}

        var viz_options = new Array(
            "-- Choose a Visualization --",
            "Wings",
            "Blob",
            "Rings"
        );

        var viz_option;

        function switchViz(i) {
            viz_option = viz_options[i];
        }
		</script>

		<div class="menu">
	        <div style="padding:0.5rem 0;">
	            <button style="float:left" data-js="play">play</button>
	            <button data-js="stop">stop</button>
	        </div>
	        <div>
	            <select name="song_selector" id="song_selector" onChange="switchSongs(selectedIndex)">
	            <script>
	            for (i = 0; (i < songs.length); i += 2) {
	              var file = songs[i];
	              var title = songs[i + 1];
	              document.write('<option value="' +
	                i + '">' +
	                title + '</option>\n');
	            }
	            </script>
	            </select>
	        </div>
            <div>
                <select name="viz_selector" id="viz_selector" onChange="switchViz(selectedIndex)">
	            <script>
	            for (i = 0; (i < viz_options.length); i += 1) {
	              var type = viz_options[i];
	              document.write('<option value="' +
	                i + '">' +
	                type + '</option>\n');
	            }
	            </script>
	            </select>
            </div>
            <a href="index.html" style="margin-top: 0.5rem;display:block;"><button><span>&#x1F525; Sim (Linear)</span></button></a>
            <a href="logarithmic.html" style="margin-top: 0.5rem;display:block;"><button>&#x1F525; Sim (Logarithmic)</button></a>
	    </div>


		<script>
            var container;
            var camera, scene, renderer;
            var composer;
            var lights = [];
            var pointLight;
            var sphere;
            var controls;

            var graph;

            var url = './songs/fuck_cancer.mp3';
            var context = new AudioContext();
            var freqs = new Array();

            init();


            function init() {
                scene = new THREE.Scene();
                container = document.createElement( 'div' );
                document.body.appendChild( container );
                camera = new THREE.PerspectiveCamera( 35, window.innerWidth / window.innerHeight, 1, 10000 );
                camera.position.set( 0, 0, 5 );

                // Materials
                var material  = new THREE.MeshBasicMaterial({color: 0xffffff, wireframe:true});
                // var material = new THREE.MeshLambertMaterial({color: 0xffffff});
                // var material = new THREE.MeshNormalMaterial();

                // Spheres geometry
                var geometry = new THREE.SphereGeometry( 1, 32, 31 );
                console.log(geometry.vertices);
                sphere = addMesh( geometry, material);
                // console.log(geometry.vertices);
                sphere.geometry.initialVertices = [];
                for (var i = 0; i < sphere.geometry.vertices.length; i++) {
                    sphere.geometry.initialVertices.push(sphere.geometry.vertices[i].clone());
                }

				// Lights

                var ambientColor = (0.15) * 0xffffff;
                var light = new THREE.AmbientLight( ambientColor );
                scene.add( light );
                lights.push(light);

                var light4 = new THREE.DirectionalLight( ambientColor );
                light4.position.set( 0.0, 0.0, 1.0 ).normalize().multiplyScalar(1.2);
                // light4.add( new THREE.Mesh( new THREE.SphereGeometry( 0.03, 8, 8 ), new THREE.MeshBasicMaterial( { color: ambientColor } ) ) );
                scene.add( light4 );
                lights.push(light4);

                var light5 = new THREE.PointLight( 0xff0000 );
                light5.position.set( 1.0, 0.0, 0.5 ).normalize().multiplyScalar(1.2);
                // light5.add( new THREE.Mesh( new THREE.SphereGeometry( 0.03, 8, 8 ), new THREE.MeshBasicMaterial( { color: 0xff0000 } ) ) );
                scene.add( light5 );
                lights.push(light5);

                renderer = new THREE.WebGLRenderer( { antialias: true } );
                renderer.setPixelRatio( window.devicePixelRatio );
                renderer.setSize( window.innerWidth, window.innerHeight );
                container.appendChild( renderer.domElement );
                window.addEventListener( 'resize', onWindowResize, false );

                // Controls
                controls = new THREE.OrbitControls( camera, renderer.domElement );
                controls.enableDamping = true;
                controls.autoRotate = true;
                controls.dampingFactor = 0.95;
                // controls.screenSpacePanning = false;
                controls.minDistance = 5;
                controls.maxDistance = 10;
                // controls.maxPolarAngle = Math.PI / 2;

                composer = new THREE.EffectComposer(renderer);
                renderer.autoClear = false;

                var renderModel = new THREE.RenderPass(scene, camera);
                composer.addPass(renderModel);

                var effectBloom = new THREE.BloomPass(0.8);
                composer.addPass(effectBloom);

                var effectScreen= new THREE.ShaderPass(THREE.ShaderExtras[ "screen" ]);
                effectScreen.renderToScreen = true;
                composer.addPass(effectScreen);


            }
            function addMesh( geometry, material ) {
                var mesh = new THREE.Mesh( geometry, material );
                mesh.position.y = 0.2;
                mesh.rotation.x = Math.PI;
                scene.add( mesh );
                return mesh
            }
            function init_music(buffer) {
                // Audio Stuff
                graph = createAudioGraph(buffer, context);
                var play = document.querySelector('[data-js="play"]'),
                    stop = document.querySelector('[data-js="stop"]'),
                    info = document.querySelector('[data-js="info"]');
                play.addEventListener('click', function() {
                    if (graph.getPlaying()) {
                        graph.pause();
                        play.innerHTML = 'play';
                    } else {
                        graph.play();
                        play.innerHTML = 'pause';
                    }
                });
                stop.addEventListener('click', function() {
                    graph.stop();
                    play.innerHTML = 'play';
                });
            }
            function load_music(url) {
                var request = new XMLHttpRequest();
                request.open("GET", url, true);
                request.responseType = "arraybuffer";
                request.onload = function() {
                    context.decodeAudioData(request.response, init_music, error);
                }
                request.send();
            }

            function createAudioGraph(buffer, context) {
                var source = null
                    startedAt = 0,
                    pausedAt = 0,
                    playing = false,
                    scriptNode = null;
                var play = function() {
                    // Initializes node to stream in audio data in chunks
                    scriptNode = context.createScriptProcessor(2048, 2, 2);
                    scriptNode.buffer = buffer;
                    scriptNode.connect(context.destination);

                    // Creates node to analyze data from the left channel
                    var analyser = context.createAnalyser();
                    analyser.smoothingTimeConstant = 0.6;
                    analyser.fftSize = 256;

                    // Initializes source node to play the audio
                    source = context.createBufferSource();
                    source.buffer = buffer;
                    source.loop = false;

                    source.connect(analyser);
                    // Each analyzer is connected to the script node to receive data
                    analyser.connect(scriptNode);

                    // The source is connected to the audio file
                    source.connect(context.destination);

                    scriptNode.onaudioprocess = function(e) {
                        freqs = new Uint8Array(analyser.frequencyBinCount);
                        analyser.getByteFrequencyData(freqs);
                        var volume = getAverageVolume(freqs);
                        render(freqs, volume);
                    };

                    var offset = pausedAt;
                    startedAt = context.currentTime - offset;
                    pausedAt = 0;
                    playing = true;
                    source.start(0, offset);
                }
                function getAverageVolume(array) {
                    var total_freq = 0;

                    for (var i = 0; i < array.length; ++i) {
                        total_freq += array[i];
                    }

                    return total_freq / array.length;
                }
                var pause = function() {
                    var elapsed = context.currentTime - startedAt;
                    stop();
                    pausedAt = elapsed;
                };
                var stop = function() {
                    if (source) {
                        if (scriptNode) {
                            scriptNode.disconnect(context.destination);
                        }
                        source.disconnect();
                        source.stop(0);
                        source = null;
                    }
                    pausedAt = 0;
                    startedAt = 0;
                    playing = false;
                };
                var getPlaying = function() {
                    return playing;
                };
                var getCurrentTime = function() {
                    if(pausedAt) {
                        return pausedAt;
                    }
                    if(startedAt) {
                        return context.currentTime - startedAt;
                    }
                    return 0;
                };
                var getDuration = function() {
                  return buffer.duration;
                };
                return {
                    getCurrentTime: getCurrentTime,
                    getDuration: getDuration,
                    getPlaying: getPlaying,
                    play: play,
                    pause: pause,
                    stop: stop
                };
            }

            function error(e){
                console.error('ERROR: context.decodeAudioData:', e);
            }
            function onWindowResize() {
            	camera.aspect = window.innerWidth / window.innerHeight;
            	camera.updateProjectionMatrix();
            	renderer.setSize( window.innerWidth, window.innerHeight );
            }

            function interpolate(a,b,x,y,t) {
                var source_dist = y - x;
                var dist = (t-x) / source_dist;
                var target_dist = b - a;
                // console.log(dist * target_dist + a);
                return dist * target_dist + a;
            }
            function render(freqs, volume) {
                // console.log(freqs);
                if (viz_option == "Wings") {
                    render_wings(freqs, volume, 0.5, 1.5);
                }
                else if (viz_option == "Rings") {
                    render_rings(freqs, volume, 0.2, 1.0);
                } else if (viz_option == "Blob"){
                    var spectrum = freqs.slice(4, freqs.length);
                    for ( var i = 0 ; i < sphere.geometry.vertices.length; i ++ ) {
                        if (i < spectrum.length) {
                            var temp = sphere.geometry.initialVertices[i].clone().multiplyScalar(Math.max(spectrum[i] / 255, 0.2));
                            sphere.geometry.vertices[i].multiplyScalar(0.0);
                            sphere.geometry.vertices[i].add(temp);
                        }
                        else {
                            var temp = sphere.geometry.initialVertices[i].clone().multiplyScalar(0.2);
                            sphere.geometry.vertices[i].multiplyScalar(0.0);
                            sphere.geometry.vertices[i].add(temp);
                        }
                    }
                }

                sphere.geometry.verticesNeedUpdate = true;
                // sphere.geometry.normalsNeedUpdate = true;
                renderer.render( scene, camera );
                // controls.update();
                sphere.rotation.x += 0.03;
                sphere.rotation.y += 0.02;
                sphere.rotation.z += 0.02;
                composer.render();
            }
            function create_buckets(freqs, offset, num) {
                sliced_freqs = freqs.slice(offset, freqs.length);
                var spectrum = [];
                var size = Math.floor(sliced_freqs.length / num);
                for (var i = 0; i < 32; i ++) {
                    var sum = 0.0;
                    for (var j = 0; j < size; j++) {
                        sum += sliced_freqs[i*size + j] / size;
                    }
                    spectrum.push(sum);
                }
                return spectrum;
            }
            function render_rings(freqs, volume, lower, higher) {
                spectrum_32 = create_buckets(freqs, 10, 32);
                // first vertex
                var val = interpolate(lower, higher, 0.0, 255.0, spectrum_32[0]);
                var temp = sphere.geometry.initialVertices[0].clone().multiplyScalar(val);
                sphere.geometry.vertices[0].multiplyScalar(0.0);
                sphere.geometry.vertices[0].add(temp);
                for (var i = 1; i < sphere.geometry.vertices.length; i +=1) {
                    var index = Math.floor(i / 32) + 1;
                    var val = interpolate(lower, higher, 0.0, 255.0, spectrum_32[index]);
                    var temp = sphere.geometry.initialVertices[i].clone().multiplyScalar(val);
                    sphere.geometry.vertices[i].multiplyScalar(0.0);
                    sphere.geometry.vertices[i].add(temp);
                }
            }

            function render_wings(freqs, volume, lower, higher) {
                spectrum_32 = create_buckets(freqs, 10, 32);
                for (var i = 0; i < sphere.geometry.vertices.length; i ++) {
                    var temp = sphere.geometry.initialVertices[i].clone().multiplyScalar(lower);
                    sphere.geometry.vertices[i].multiplyScalar(0.0);
                    sphere.geometry.vertices[i].add(temp);
                }

                for (var i = 1; i < sphere.geometry.vertices.length; i +=32) {
                    var index = Math.floor(i / 32);
                    var val = interpolate(lower, higher, 0.0, 255.0, spectrum_32[index]);
                    var temp = sphere.geometry.initialVertices[i].clone().multiplyScalar(val);
                    sphere.geometry.vertices[i].multiplyScalar(0.0);
                    sphere.geometry.vertices[i].add(temp);
                    if (i + 16 < sphere.geometry.vertices.length) {
                        var temp2 = sphere.geometry.initialVertices[i+16].clone().multiplyScalar(val);
                        sphere.geometry.vertices[i+16].multiplyScalar(0.0);
                        sphere.geometry.vertices[i+16].add(temp2);
                    }
                }
            }

            function render_blob(freqs, volume, lower, higher) {

            }


		</script>

	</body>
</html>
